{%extends 'base.html'%}
{%block content%}
<div class="pure-g-r content-ribbon">
	<div class="pure-u-1">
		<ul class="breadcrumb">
			<li><a href="{% url 'core:home' %}">Início</a></li>
			<li>/</li>
			<li><a href="{% url 'forum:index' %}">Página de discussões</a></li>
			<li>/</li>
			<li><a href="{{object.get_absolute_url}}">{{object}}</a></li>
		</ul>
	</div>
	<div class="pure-u-1-3">
		<div class="pure-menu pure-menu-open">
			<ul>
				<li class="pure-menu-heading">Tópicos : </li>
				<li><a href="?order=updated_at"><i class="fas fa-sync"></i> Mais recentes</a></li>
				<li><a href="?order=views"><i class="fas fa-eye"></i> Mais visualizados</a></li>
				<li><a href="?order=answers"><i class="fas fa-comments"></i> Mais comentados</a></li>

				<li class="pure-menu-heading">Tags : </li>
				{% for tag in tags %}
				<li><a href="{% url 'forum:index_tagged' tag.slug%}"><i class="fas fa-tag"> {{tag}}</i></a></li>
				{% endfor %}
			</ul>
		</div>
	</div>
	<div class="pure-u-2-3">
		<div class="inner">
			<div class="well">
				<h2>{{object}}</h2>
				{{object.body|linebreaks}}
				<h5>Criado por {{object.user}}</h5>
				<p>
					<i class="fas fa-tags"></i>
					{%for tag in object.tags.all%}
					<a href="{%url 'forum:index_tagged' tag.slug%}">{{tag}}</a>{% if not forloop.last%}, {%endif%}
					{%endfor%}
					<a class="fright">Criado há {{object.created_at|timesince}}</a>
				</p>
			</div>
			<div class="well" id="div-comments">
				<h4>Respostas /
				<a class="fright" href="#responder">Responder</a></h4>
				{%for reply in object.thread_reply.all%}
				<hr>
				<p>
					<strong>{% if reply.author %}{{reply.author}}{%else%}(Usuário desconhecido){%endif%} disse há {{reply.created_at|timesince}}</strong>
					{{reply.reply|linebreaksbr}}
					{% if object.user == user %}
						<br>
						<a href="{% url 'forum:reply-incorrect' reply.pk %}" class="pure-button button-error reply-cancel-correct-lnk {% if not reply.correct%} hidden {% endif %}">Cancelar resposta correta</a>

						<a href="{% url 'forum:reply-correct' reply.pk %}" class="pure-button button-sucess reply-correct-lnk {% if reply.correct %} hidden {%endif%}%">Indicar resposta correta</a>

						<span class="fright label-sucess correct-reply-msg {% if not reply.correct%} hidden {%endif%}"> Resposta indicada pelo autor </span>	
					{% elif reply.correct %}
						<br>
						<span class="fright label-sucess"> Resposta indicada pelo autor </span>	
						
					{% endif %}
				</p>
				{%empty%}
				<strong>Não há respostas para esse tópico</strong>
				{%endfor%}
				<hr>
				<form class="pure-form pure-form-stacked" method="post" id = "responder">
					<fieldset>
						{%csrf_token%}
						{% for field in form%}
						<div class="pure-control-group">
							{{field.label_tag}}
							{{field}}
							{{field.errors}}
						</div>
						{% endfor %}
						<div class="pure-control">
							<button type="submit" class="pure-button pure-button-primary">Enviar</button>
						</div>
					</fieldset>
				</form>
			</div>
		</div>
	</div>
{%endblock%}
{% block scripts %}
<script type="text/javascript">
	$(".reply-cancel-correct-lnk").click(function(e){
		e.preventDefault()
		var $this = $(this)
		var $p = $this.closest("p")
		$.get($this.attr('href'), function(data){
			if (data.sucess){
				$p.find(".correct-reply-msg".addClass('hidden'));
				$this.addClass('hidden');
				$p.find(".reply-correct-link".removeClass('hidden'));
			}

			else{
				alert(data.message);
			}
		} , 'json');
		return false;
	});
	$(".reply-cancel-correct-lnk").click(function(e){
		e.preventDefault()
		var $this = $(this)
		var $p = $this.closest("p")
		$.get($this.attr('href'), function(data){
			if (data.sucess){
				$("#div-comments .correct-reply-msg").addClass('hidden');
				$("#div-comments .reply-cancel-correct-lnk").addClass('hidden');
				$("#div-comments .reply-correct-lnk").removeClass('hidden');

				$p.find(".correct-reply-msg".removeClass('hidden'))
				$this.addClass('hidden')
				$p.find(".reply-cancel-correct-lnk".removeClass('hidden'))
			}
			else{
				alert(data.message);
			}
		}, 'json');
		return false;
	});
</script>
{% endblock %}